<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>改行コード可視化ツール</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
      font-size: 24px;
    }
    h2 {
      font-size: 18px;
      margin-top: 25px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: bold;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
    }
    .controls {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    .setting-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    input[type="text"], input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="number"] {
      width: 80px;
    }
    input[type="text"] {
      width: 150px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #45a049;
    }
    .blue-button {
      background-color: #2196F3;
    }
    .blue-button:hover {
      background-color: #0b7dda;
    }
    .orange-button {
      background-color: #ff9800;
    }
    .orange-button:hover {
      background-color: #e68a00;
    }
    .output-container {
      margin-top: 20px;
    }
    .output {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      min-height: 100px;
      line-height: 1.5;
    }
    .stats {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .tag-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .tag {
      background-color: #e0e0e0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
    }
    .tag button {
      background: none;
      border: none;
      color: #f44336;
      cursor: pointer;
      font-size: 14px;
      padding: 0 0 0 5px;
      margin: 0;
    }
    .highlight {
      margin-top: 15px;
    }
    .line-start-chars {
      width: 100%;
    }
    .prohibited-char {
      color: #f44336;
      font-weight: bold;
    }
    .warning-box {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }
    .tab-container {
      margin-top: 20px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .tab-button {
      padding: 10px 15px;
      background-color: #f1f1f1;
      border: none;
      cursor: pointer;
      transition: 0.3s;
      font-size: 14px;
      border-radius: 4px 4px 0 0;
      margin-right: 2px;
    }
    .tab-button:hover {
      background-color: #ddd;
    }
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 15px;
      border: 1px solid #ddd;
      border-top: none;
      animation: fadeEffect 1s;
    }
    @keyframes fadeEffect {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>改行コード可視化ツール</h1>
    <p>テキスト内の改行コードを実際の改行に変換して表示します。タグの除外や行頭禁則文字の確認もできます。</p>
    
    <div class="controls" style="display: flex; gap: 10px; margin-bottom: 15px;">
      <button id="process" class="orange-button" style="flex: 1;">変換</button>
      <button id="switch-to-output" class="blue-button" style="flex: 1;">結果を表示</button>
    </div>
    
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'tab-input')">入力と設定</button>
        <button class="tab-button" onclick="openTab(event, 'tab-output')">変換結果</button>
        <button class="tab-button" onclick="openTab(event, 'tab-help')">ヘルプ</button>
      </div>
      
      <div id="tab-input" class="tab-content active">
        <label for="input-text">テキストを入力してください：</label>
        <textarea id="input-text" placeholder="ここにテキストを入力してください。例：ピオが鉱山にいた頃のナカマ。\nなぜか魂だけ残っている。\n\nスキル：ウサギが全て半透明化\n攻撃力と防御力が上昇\n敵の監視や特殊攻撃も\n回避できるようになる！">ピオが鉱山にいた頃のナカマ。\nなぜか魂だけ残っている。\n\nスキル：ウサギが全て半透明化\n攻撃力と防御力が上昇\n敵の監視や特殊攻撃も\n回避できるようになる！</textarea>
        
        <h2>基本設定</h2>
        <div class="setting-row">
          <label for="newline-code">改行コード：</label>
          <input type="text" id="newline-code" value="\n" placeholder="\n, <br>など">
          
          <label for="max-chars" style="margin-left: 20px;">1行の最大文字数：</label>
          <input type="number" id="max-chars" value="20" min="1">
        </div>
        
        <h2>タグ除外設定</h2>
        <p>タグ自体（&lt;タグ&gt;や&lt;/タグ&gt;）を変換結果から除外し、タグで囲まれた内容は残します。</p>
        <div class="setting-row">
          <input type="checkbox" id="ignore-tags" checked>
          <label for="ignore-tags" style="display: inline;">タグを除外する（内容は保持）</label>
        </div>
        <div class="setting-row">
          <label for="custom-tag">タグを追加：</label>
          <input type="text" id="custom-tag" placeholder="例: color">
          <button id="add-tag" class="blue-button">追加</button>
        </div>
        <div class="tag-list" id="tag-list">
          <div class="tag">color <button onclick="removeTag('color')">×</button></div>
          <div class="tag">b <button onclick="removeTag('b')">×</button></div>
          <div class="tag">i <button onclick="removeTag('i')">×</button></div>
        </div>
        
        <h2>行頭禁則設定</h2>
        <p>指定した文字が行頭に来た場合、警告を表示します。</p>
        <div class="setting-row">
          <input type="checkbox" id="check-prohibited" checked>
          <label for="check-prohibited" style="display: inline;">行頭禁則をチェックする</label>
        </div>
        <label for="prohibited-chars">行頭禁則文字：</label>
        <textarea id="prohibited-chars" class="line-start-chars">』」）〕］｝〉》】｠〙〗»〟'")]}｣。．、，､｡,.‐〜゠–！？‼⁇⁈⁉!?・：；･:;ヽヾゝゞ々〻ーｰぁぃぅぇぉァィゥェォっゃゅょゎゕゖッャュョヮヵヶㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿｧｨｩｪｫｬｭｮｯ</textarea>
        
        <!-- ボタンは上部に移動したため削除 -->
      </div>
      
      <div id="tab-output" class="tab-content">
        <div class="output-container">
          <div class="setting-row">
            <input type="checkbox" id="show-newlines">
            <label for="show-newlines" style="display: inline;">改行を可視化</label>
            
            <button id="copy-output" class="blue-button" style="margin-left: 20px;">結果をコピー</button>
            <button id="download-html" class="orange-button" style="margin-left: 10px;">HTMLをダウンロード</button>
          </div>
          
          <div id="warning-box" class="warning-box">
            <strong>警告:</strong> <span id="warning-message"></span>
          </div>
          
          <label for="output">変換結果：</label>
          <div id="output" class="output"></div>
          <div id="stats" class="stats"></div>
        </div>
      </div>
      
      <div id="tab-help" class="tab-content">
        <h2>使い方</h2>
        <ol>
          <li>「入力と設定」タブでテキストを入力します。</li>
          <li>必要に応じて改行コードや最大文字数を設定します。</li>
          <li>タグを除外したい場合は「タグを除外する」にチェックを入れ、必要なタグを追加します。</li>
          <li>行頭禁則チェックを行いたい場合は「行頭禁則をチェックする」にチェックを入れます。</li>
          <li>「変換」ボタンをクリックして処理を実行します。</li>
          <li>「結果を表示」ボタンをクリックするか、「変換結果」タブをクリックして結果を確認します。</li>
        </ol>
        
        <h2>機能説明</h2>
        <ul>
          <li><strong>改行コード設定</strong>: 任意の改行コードを指定できます（例: \n, &lt;br&gt;, //n など）</li>
          <li><strong>タグ除外</strong>: &lt;タグ&gt;内容&lt;/タグ&gt; 形式のテキストから、タグ部分のみを除外し内容は保持します。</li>
          <li><strong>行頭禁則チェック</strong>: 指定した文字が行頭に来た場合に警告します。</li>
          <li><strong>改行可視化</strong>: 改行位置を「↵」記号で表示します。</li>
          <li><strong>HTMLダウンロード</strong>: このツール自体をHTMLファイルとしてダウンロードできます。</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // タブ切り替え機能
    function openTab(evt, tabName) {
      var i, tabContent, tabButtons;
      tabContent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabContent.length; i++) {
        tabContent[i].classList.remove("active");
      }
      tabButtons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    document.addEventListener('DOMContentLoaded', () => {
      const inputText = document.getElementById('input-text');
      const newlineCode = document.getElementById('newline-code');
      const maxChars = document.getElementById('max-chars');
      const ignoreTags = document.getElementById('ignore-tags');
      const customTag = document.getElementById('custom-tag');
      const addTagBtn = document.getElementById('add-tag');
      const tagList = document.getElementById('tag-list');
      const checkProhibited = document.getElementById('check-prohibited');
      const prohibitedChars = document.getElementById('prohibited-chars');
      const processBtn = document.getElementById('process');
      const switchToOutputBtn = document.getElementById('switch-to-output');
      const copyBtn = document.getElementById('copy-output');
      const downloadBtn = document.getElementById('download-html');
      const output = document.getElementById('output');
      const stats = document.getElementById('stats');
      const showNewlines = document.getElementById('show-newlines');
      const warningBox = document.getElementById('warning-box');
      const warningMessage = document.getElementById('warning-message');
      
      // 初期タグリスト
      let tags = ['color', 'b', 'i'];
      
      // 初期処理を実行
      processText();
      
      // 処理ボタンをクリックしたとき
      processBtn.addEventListener('click', () => {
        processText();
      });
      
      // 結果表示ボタンをクリックしたとき
      switchToOutputBtn.addEventListener('click', () => {
        openTab({ currentTarget: document.querySelectorAll('.tab-button')[1] }, 'tab-output');
      });
      
      // 改行可視化チェックボックスの変更時
      showNewlines.addEventListener('change', () => {
        updateOutput();
      });
      
      // コピーボタンをクリックしたとき
      copyBtn.addEventListener('click', () => {
        copyToClipboard(output.textContent);
      });
      
      // HTMLダウンロードボタンをクリックしたとき
      downloadBtn.addEventListener('click', () => {
        downloadHtml();
      });
      
      // タグを追加ボタンをクリックしたとき
      addTagBtn.addEventListener('click', () => {
        addTag();
      });
      
      // タグ入力欄でEnterキーを押したとき
      customTag.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTag();
        }
      });
      
      // タグを追加する関数
      function addTag() {
        const tag = customTag.value.trim();
        if (tag && !tags.includes(tag)) {
          tags.push(tag);
          updateTagList();
          customTag.value = '';
          processText();
        }
      }
      
      // タグを削除する関数（グローバルスコープに配置）
      window.removeTag = function(tag) {
        tags = tags.filter(t => t !== tag);
        updateTagList();
        processText();
      };
      
      // タグリストを更新する関数
      function updateTagList() {
        tagList.innerHTML = '';
        tags.forEach(tag => {
          const tagElement = document.createElement('div');
          tagElement.className = 'tag';
          tagElement.innerHTML = `${tag} <button onclick="removeTag('${tag}')">×</button>`;
          tagList.appendChild(tagElement);
        });
      }
      
      // HTMLをダウンロードする関数
      function downloadHtml() {
        const htmlContent = document.documentElement.outerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '改行コード可視化ツール.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // クリップボードにコピーする関数
      function copyToClipboard(text) {
        navigator.clipboard.writeText(text)
          .then(() => {
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'コピーしました!';
            copyBtn.style.backgroundColor = '#4CAF50';
            setTimeout(() => {
              copyBtn.textContent = originalText;
              copyBtn.style.backgroundColor = '#2196F3';
            }, 1500);
          })
          .catch(err => {
            console.error('テキストのコピーに失敗しました:', err);
            copyBtn.textContent = 'コピー失敗';
            setTimeout(() => {
              copyBtn.textContent = '結果をコピー';
            }, 1500);
          });
      }
      
      // テキスト処理の関数
      function processText() {
        const text = inputText.value;
        const maxCharsVal = parseInt(maxChars.value, 10) || 20;
        const newlineCodeVal = newlineCode.value || '\\n';
        const ignoreTagsChecked = ignoreTags.checked;
        const checkProhibitedChecked = checkProhibited.checked;
        const prohibitedCharsVal = prohibitedChars.value;
        
        // 正規表現パターンを構築（エスケープが必要な特殊文字に対応）
        let pattern;
        // 特殊な正規表現文字をエスケープ
        const escapeRegExp = (str) => {
          return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        };
        
        // エスケープされた正規表現を作成
        pattern = new RegExp(escapeRegExp(newlineCodeVal), 'g');
        
        // テキストを処理
        let processedText = text;
        
        // 改行コードを実際の改行に変換
        processedText = processedText.replace(pattern, '\n');
        
        // タグを処理（タグ除外がチェックされている場合）
        if (ignoreTagsChecked && tags.length > 0) {
          // タグとその中身を抽出して、中身だけを残す処理
          const tagPattern = new RegExp(`<(${tags.join('|')}).*?>(.*?)</(${tags.join('|')})>`, 'gs');
          processedText = processedText.replace(tagPattern, (match, tag1, content, tag2) => {
            return content; // タグの中身だけを返す
          });
          
          // 閉じタグのないシンプルなタグを処理
          const simpleTagPattern = new RegExp(`<(?:${tags.join('|')}).*?>`, 'g');
          processedText = processedText.replace(simpleTagPattern, '');
        }
        
        // 最大文字数で折り返す処理
        let wrappedText = '';
        if (maxCharsVal > 0) {
          const lines = processedText.split('\n');
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.length <= maxCharsVal) {
              wrappedText += line + '\n';
            } else {
              let currentPos = 0;
              while (currentPos < line.length) {
                wrappedText += line.substr(currentPos, maxCharsVal) + '\n';
                currentPos += maxCharsVal;
              }
            }
          }
        } else {
          wrappedText = processedText + '\n';
        }
        
        // 処理結果を保存
        window.processedResult = wrappedText;
        
        // 出力を更新
        updateOutput();
        
        // 統計情報を表示
        const originalChars = text.length;
        const processedLines = wrappedText.split('\n').length - 1;
        
        // 改行コードの数をカウント
        const newlineMatches = text.match(pattern);
        const newlineCount = newlineMatches ? newlineMatches.length : 0;
        
        stats.textContent = `元のテキスト: ${originalChars}文字, ${newlineCodeVal}記号: ${newlineCount}個 ⟶ 変換後: ${processedLines}行`;
      }
      
      // 出力を更新する関数
      function updateOutput() {
        const wrappedText = window.processedResult;
        const showNewlinesChecked = showNewlines.checked;
        const checkProhibitedChecked = checkProhibited.checked;
        const prohibitedCharsVal = prohibitedChars.value;
        
        // 警告メッセージをリセット
        warningBox.style.display = 'none';
        warningMessage.textContent = '';
        
        // 出力
        if (showNewlinesChecked) {
          // 改行を可視化（↵で表示）
          output.textContent = '';
          const lines = wrappedText.split('\n');
          
          for (let i = 0; i < lines.length - 1; i++) {
            const lineSpan = document.createElement('span');
            
            // 行頭禁則チェック
            if (checkProhibitedChecked && lines[i].length > 0) {
              const firstChar = lines[i].charAt(0);
              if (prohibitedCharsVal.includes(firstChar)) {
                const prohibitedSpan = document.createElement('span');
                prohibitedSpan.className = 'prohibited-char';
                prohibitedSpan.textContent = firstChar;
                
                lineSpan.appendChild(prohibitedSpan);
                lineSpan.appendChild(document.createTextNode(lines[i].substring(1)));
                
                // 警告メッセージを表示
                warningBox.style.display = 'block';
                if (warningMessage.textContent) {
                  warningMessage.textContent += '、';
                }
                warningMessage.textContent += `行頭に禁則文字「${firstChar}」があります`;
              } else {
                lineSpan.textContent = lines[i];
              }
            } else {
              lineSpan.textContent = lines[i];
            }
            
            output.appendChild(lineSpan);
            
            const newlineSymbol = document.createElement('span');
            newlineSymbol.textContent = '↵';
            newlineSymbol.style.color = '#ff6b6b';
            newlineSymbol.style.fontWeight = 'bold';
            output.appendChild(newlineSymbol);
            output.appendChild(document.createElement('br'));
          }
        } else {
          // 通常表示
          output.innerHTML = '';
          const lines = wrappedText.split('\n');
          
          for (let i = 0; i < lines.length - 1; i++) {
            const lineDiv = document.createElement('div');
            
            // 行頭禁則チェック
            if (checkProhibitedChecked && lines[i].length > 0) {
              const firstChar = lines[i].charAt(0);
              if (prohibitedCharsVal.includes(firstChar)) {
                const prohibitedSpan = document.createElement('span');
                prohibitedSpan.className = 'prohibited-char';
                prohibitedSpan.textContent = firstChar;
                
                lineDiv.appendChild(prohibitedSpan);
                lineDiv.appendChild(document.createTextNode(lines[i].substring(1)));
                
                // 警告メッセージを表示
                warningBox.style.display = 'block';
                if (warningMessage.textContent) {
                  warningMessage.textContent += '、';
                }
                warningMessage.textContent += `行頭に禁則文字「${firstChar}」があります`;
              } else {
                lineDiv.textContent = lines[i];
              }
            } else {
              lineDiv.textContent = lines[i];
            }
            
            output.appendChild(lineDiv);
          }
        }
      }
      
      // タグリストを初期化
      updateTagList();
    });
  </script>
</body>
</html>
